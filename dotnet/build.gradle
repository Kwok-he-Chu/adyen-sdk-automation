import com.adyen.sdk.Service
import org.openapitools.generator.gradle.plugin.tasks.GenerateTask

plugins {
    id 'adyen.sdk-automation-conventions'
}

project.ext {
    generator = 'csharp'
    templates = 'templates-v7/csharp/libraries/generichost'
}

def services = project.ext.services as List<Service>

services.each { Service svc ->
    def serviceName = project.ext.serviceNaming[svc.id] as String
    // Generation

    tasks.named("generate${svc.name}", GenerateTask) {
        println "Generating ${svc.name}..."
        apiPackage.set("Service.${svc.name}")
        apiNameSuffix.set('Service')
        modelPackage.set("Model.${svc.name}")
/*        reservedWordsMappings.putAll([
                "version": "Version",
//                "Version": "Version",
//                "VarVersion": "Version",
//                "varVersion": "Version",
//                "timeZone": "TimeZone",
//                "environment": "Environment"
        ])*/
//        parameterNameMappoing.putAll([
//                "gag": "Dsgs"
//        ])

        additionalProperties.putAll([
                // Target framework version
                'targetFramework': 'netstandard2.0',

                // HTTP library template sub-folder/template to use:
                'library': 'generichost',

                // Your C# package name (convention: Camel.Case).
                'packageName': 'Adyen',

                // Api -suffix
                'apiName': 'Api',

                // Make API response's headers case-insensitive
                'caseInsensitiveResponseHeaders': 'false',

                // Override Equals and GetHashCode methods
                'equatable': 'true',

                'serviceName': serviceName,

                // Use nullable annotations in the project.
                // Only supported on C# 8 / ASP.NET Core 3.1 or newer.
                // Starting in .NET 6.0 the default is true.
                'nullableReferenceTypes': 'false',

                // Your prefix for interfaces
                'interfacePrefix': 'I',

                // Use DateTime to model date properties even if DateOnly supported. (.NET 6.0+ only)
                'useDateTimeForDate': 'true',

                // Use the discriminator's mapping in oneOf to speed up the model lookup.
                // IMPORTANT NOTE: Validation (e.g. one and only one match in oneOf's schemas) will be skipped.
                'useOneOfDiscriminatorLookup': 'true',

//                'reserved-words-mappings':  [
//                    'Version': 'VersionVV',
//                    'version': 'Versionvv',
//                    'VarVersion': 'VersionVVar',
//                    'varVersion': 'Versionvvar',
//                    'TimeZone': 'TimeZone',
//                    'Environment': 'Environment',
//                ]
        ])

//        templateDir.set("$projectDir/repo/templates-v7/libraries/csharp")
//        // Generate webhook handlers for webhooks
//        if (serviceId.endsWith("webhooks")) {
//            configFile.set("$projectDir/config.yaml")
//        }
    }

    // Deployment
    def deployModels = tasks.register("deploy${svc.name}Models", Sync) {
        println "Moving ${svc.name}-Models..."
        group 'deploy'
        description "Deploy $svc.name models into the repo."
        dependsOn "generate$svc.name"
        outputs.upToDateWhen { false }

        from layout.buildDirectory.dir("services/$svc.id/src/Adyen/Model.${serviceName}")
        into layout.projectDirectory.dir("repo/Adyen/Model/" + serviceName)
    }

    def deployServices = tasks.register("deploy${svc.name}Services", Sync) {
        println "Moving ${svc.name}-Services..."
        group 'deploy'
        description "Deploy $svc.name into the repo."
        dependsOn "generate$svc.name"
        outputs.upToDateWhen { false }

        from layout.buildDirectory.dir("services/$svc.id/src/Adyen/Service.${serviceName}")
        into layout.projectDirectory.dir("repo/Adyen/Service/" + serviceName)
    }

//    def deploySmallService = tasks.register("deploy${svc.name}SmallService", Copy) {
//        println "Moving ${svc.name}-SmallServices..."
//        group 'deploy'
//        description "Copy $svc.name into the repo."
//        dependsOn "generate$svc.name"
//        outputs.upToDateWhen { false }
//
//        from layout.buildDirectory.file("services/$svc.id/src/Adyen/Service/DefaultService.cs")
//        rename 'DefaultService.cs', "${serviceName}Service.cs"
//        filter {
//            it.replace('DefaultService', "${serviceName}Service")
//        }
//        into layout.projectDirectory.dir("repo/Adyen/Service")
//    }

    tasks.named(svc.id) { dependsOn deployModels, deployServices }
}

// Tests
tasks.named('binlookup') {
    doLast {
        assert file("${layout.projectDirectory}/repo/Adyen/Model/BinLookup/Amount.cs").exists()
        assert file("${layout.projectDirectory}/repo/Adyen/Service/BinLookupService.cs").exists()
    }
}
tasks.named('checkout') {
    doLast {
        assert file("${layout.projectDirectory}/repo/Adyen/Model/Checkout/Amount.cs").exists()
        assert file("${layout.projectDirectory}/repo/Adyen/Service/Checkout/PaymentsService.cs").exists()
    }
}
/* TODO: ACS does not exist.
tasks.named('acswebhooks') {
    doLast {
        assert file("${layout.projectDirectory}/repo/Adyen/Model/AcsWebhooks/Amount.cs").exists()
        assert !file("${layout.projectDirectory}/repo/Adyen/Service/AcsWebhooks").exists()
        assert !file("${layout.projectDirectory}/repo/Adyen/Service/AcsWebhooksService.cs").exists()
    }
}
*/